<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán N√≥i Ti·∫øng ƒê·ª©c Pro - N√¢ng C·∫•p</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align top */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
        }
        h1 {
            color: #0d6efd;
            margin-bottom: 25px;
        }
        h2 {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
            resize: vertical;
        }
        .controls, .session-controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        button {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        button#record-btn { background-color: #198754; }
        button#record-btn:hover { background-color: #157347; }
        .dialogue-box { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; text-align: left; }
        .line { padding: 12px; margin: 8px 0; border-radius: 8px; font-size: 1.1rem; }
        .computer-line { background-color: #e7f3ff; }
        .user-line { background-color: #fff3cd; font-weight: bold; border: 2px dashed #ffc107; }
        .status { margin-top: 20px; font-size: 1.1rem; font-weight: bold; min-height: 50px; padding: 10px; border-radius: 8px;}
        .status.success { color: #146c43; background-color: #d1e7dd; }
        .status.error { color: #b02a37; background-color: #f8d7da; }
        .instructions { font-size: 0.9rem; color: #606770; text-align: left; margin-bottom: 20px; background: #eef; padding: 15px; border-radius: 8px; border-left: 4px solid #0d6efd; }
        #review-area { text-align: left; margin-top: 20px; }
        .review-line { padding: 12px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .review-line.computer { background-color: #e7f3ff; }
        .review-line.user { background-color: #d1e7dd; font-weight: 500;}
        .play-recording-btn { background-color: #fd7e14; padding: 6px 12px; font-size: 0.9rem; }
        .play-recording-btn:hover { background-color: #e46e0e; }
        #play-all-btn { background-color: #0dcaf0; }
        #play-all-btn:hover { background-color: #0aa8c2; }
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            text-align: left;
        }
        .difficulty-selection, .custom-feedback-area {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .difficulty-selection fieldset {
            border: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: space-around;
        }
        .difficulty-selection legend {
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
        }
        .feedback-box {
            font-size: 1rem;
            font-weight: normal;
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
            text-align: left;
            line-height: 1.7;
        }
        .diff-correct { color: #000; }
        .diff-incorrect { color: #dc3545; text-decoration: underline; font-weight: bold; }
        .diff-missing { color: #6c757d; font-style: italic; }
        #audio-canvas {
            display: block;
            width: 100%;
            height: 60px;
            background-color: #f0f2f5;
            border-radius: 8px;
            margin: 15px 0;
        }
        #score-area {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ffc107;
            color: #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .auto-record-toggle {
            margin-top: 10px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* CSS CHO PH·∫¶N T·∫¢I H·ªòI THO·∫†I */
        #danh-sach-hoi-thoai {
            text-align: left;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        #danh-sach-hoi-thoai h2 {
            margin-top: 0;
            border-bottom: none;
            font-size: 1.1rem;
        }
        .file-button {
            background-color: #0d6efd;
            margin: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
            text-transform: capitalize;
        }
        .file-button:hover {
            background-color: #0b5ed7;
        }
    </style>
</head>
<body>
    <div id="score-area">ƒêi·ªÉm: 100</div>
    <div class="container">
        <h1>Luy·ªán Giao Ti·∫øp Chuy√™n Nghi·ªáp üöÄ</h1>
        
        <div id="danh-sach-hoi-thoai"></div>
        
        <div id="initial-setup">
            <div class="instructions">
                <strong>H∆∞·ªõng d·∫´n:</strong>
                <ol>
                    <li>Ch·ªçn m·ªôt h·ªôi tho·∫°i c√≥ s·∫µn ·ªü tr√™n ho·∫∑c d√°n h·ªôi tho·∫°i c·ªßa b·∫°n v√†o √¥ b√™n d∆∞·ªõi.</li>
                    <li>Ch·ªçn ƒë·ªô kh√≥ v√† c√°c t√πy ch·ªânh kh√°c.</li>
                    <li>Nh·∫•n <strong>"B·∫Øt ƒê·∫ßu Luy·ªán T·∫≠p"</strong>.</li>
                    <li>N·∫øu "T·ª± ƒë·ªông ghi √¢m" ƒë∆∞·ª£c b·∫≠t, ·ª©ng d·ª•ng s·∫Ω t·ª± b·∫Øt ƒë·∫ßu nghe sau khi m√°y n√≥i xong.</li>
                    <li>N·∫øu kh√¥ng, b·∫°n c·∫ßn nh·∫•n n√∫t "B·∫Øt ƒê·∫ßu Ghi √Çm".</li>
                </ol>
            </div>

            <div class="settings-grid">
                <div class="difficulty-selection">
                    <fieldset>
                        <legend>Ch·ªçn ƒê·ªô Kh√≥</legend>
                        <div><input type="radio" id="easy" name="difficulty" value="80" checked> <label for="easy">D·ªÖ (80%)</label></div>
                        <div><input type="radio" id="medium" name="difficulty" value="90"> <label for="medium">TB (90%)</label></div>
                        <div><input type="radio" id="hard" name="difficulty" value="100"> <label for="hard">Kh√≥ (100%)</label></div>
                    </fieldset>
                    <div class="auto-record-toggle">
                        <input type="checkbox" id="auto-record" checked>
                        <label for="auto-record">T·ª± ƒë·ªông ghi √¢m</label>
                    </div>
                </div>
                <div class="custom-feedback-area">
                    <textarea id="rewards-input" rows="3" placeholder="Ph·∫ßn th∆∞·ªüng (m·ªói d√≤ng m·ªôt c√¢u)...&#10;L√†m t·ªët l·∫Øm!&#10;Ph√°t √¢m chu·∫©n!">L√†m t·ªët l·∫Øm!&#10;Ph√°t √¢m chu·∫©n!&#10;Tuy·ªát v·ªùi!&#10;B·∫°n th·∫≠t si√™u!</textarea>
                    <textarea id="penalties-input" rows="3" placeholder="H√¨nh ph·∫°t (m·ªói d√≤ng m·ªôt c√¢u)...&#10;C·ªë l√™n n√†o!&#10;Th·ª≠ l·∫°i l·∫ßn n·ªØa nh√©.">C·ªë l√™n n√†o!&#10;Th·ª≠ l·∫°i l·∫ßn n·ªØa nh√©.&#10;ƒê·ª´ng n·∫£n l√≤ng.&#10;S·∫Øp ƒë∆∞·ª£c r·ªìi!</textarea>
                </div>
            </div>

            <div class="settings-grid" style="margin-top: 15px;">
                <div class="custom-feedback-area">
                    <label for="success-audio">√Çm thanh khi th√†nh c√¥ng (.mp3):</label>
                    <input type="file" id="success-audio" accept=".mp3">
                </div>
                <div class="custom-feedback-area">
                    <label for="failure-audio">√Çm thanh khi th·∫•t b·∫°i (.mp3):</label>
                    <input type="file" id="failure-audio" accept=".mp3">
                </div>
            </div>

            <textarea id="dialogue-input" rows="6" placeholder="D√°n h·ªôi tho·∫°i c·ªßa b·∫°n ·ªü ƒë√¢y...&#10;V√≠ d·ª•:&#10;A: Hallo, wie geht's?&#10;B: Mir geht's gut, danke."></textarea>
            
            <div class="controls">
                <button id="load-btn">üöÄ B·∫Øt ƒê·∫ßu Luy·ªán T·∫≠p</button>
                <button id="swap-roles-btn">üîÅ ƒê·ªïi Vai (Hi·ªán t·∫°i: B·∫°n l√† B)</button>
            </div>
        </div>

        <div id="practice-area" class="dialogue-box" style="display: none;">
            <h2>L·ªùi tho·∫°i c·ªßa m√°y:</h2>
            <div id="computer-line" class="line computer-line">...</div>
            <div id="user-line-container">
                 <h2 id="user-line-title">C√¢u c·ªßa b·∫°n:</h2>
                 <div id="user-line" class="line user-line" style="display: none;">...</div>
            </div>
        </div>
        
        <div id="status-area" class="status"></div>
        
        <div id="interim-transcript-area" class="feedback-box" style="display: none; margin-top: 15px; min-height: 50px; font-style: italic; color: #6c757d;"></div>
        
        <canvas id="audio-canvas" style="display: none;"></canvas>

        <div id="session-controls-area" style="display: none;">
            <div class="session-controls">
                <button id="record-btn" disabled>üé§ B·∫Øt ƒê·∫ßu Ghi √Çm</button>
                <button id="toggle-line-btn" disabled>üôà Hi·ªán L·ªùi Tho·∫°i</button>
            </div>
        </div>
        
        <div id="review-area" style="display: none;">
            <h2>Xem L·∫°i H·ªôi Tho·∫°i</h2>
            <div id="review-content"></div>
            <div class="controls" style="margin-top: 20px;">
                <button id="play-all-btn">‚ñ∂Ô∏è Nghe l·∫°i to√†n b·ªô</button>
                <button id="restart-session-btn">üîÅ Luy·ªán t·∫≠p l·∫°i h·ªôi tho·∫°i n√†y</button>
                <button id="choose-new-btn" style="background-color: #6c757d;">üè† Ch·ªçn h·ªôi tho·∫°i kh√°c</button>
            </div>
        </div>
    </div>

    <script>
       document.addEventListener('DOMContentLoaded', function() {
    // --- B·∫ÆT ƒê·∫¶U PH·∫¶N T·∫¢I H·ªòI THO·∫†I T·ª™ GITHUB ---
    const owner = 'truongkhaai136-dot';
    const repo = 'webtiengduc';
    const baseFolderPath = 'hoi-thoai';
    const conversationContainer = document.getElementById('danh-sach-hoi-thoai');
    const dialogueInput = document.getElementById('dialogue-input');

    let fileList = [];

    function loadFileContent(downloadUrl, buttonElement) {
        document.querySelectorAll('.file-button').forEach(btn => btn.disabled = true);
        buttonElement.textContent = 'ƒêang t·∫£i...';

        fetch(downloadUrl)
            .then(response => response.text())
            .then(content => {
                dialogueInput.value = content;
                dialogueInput.focus();
                dialogueInput.scrollTop = 0;

                buttonElement.textContent = 'ƒê√£ t·∫£i th√†nh c√¥ng!';
                buttonElement.style.backgroundColor = '#198754';

                setTimeout(() => {
                    document.querySelectorAll('.file-button').forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = btn.dataset.filename;
                        btn.style.backgroundColor = '#0d6efd';
                    });
                }, 1500);
            })
            .catch(error => {
                console.error('L·ªói khi t·∫£i n·ªôi dung file:', error);
                buttonElement.textContent = 'T·∫£i l·ªói!';
                buttonElement.style.backgroundColor = '#dc3545';
            });
    }

    function renderFileList() {
        if (!conversationContainer) return;
        conversationContainer.innerHTML = '<h2>Ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu:</h2>';

        fileList.sort((a, b) => a.path.localeCompare(b.path));

        fileList.forEach(file => {
            const button = document.createElement('button');
            const prettyName = file.path
                .replace(baseFolderPath + '/', '')
                .replace('.txt', '')
                .replace(/\//g, ' / ')
                .replace(/_/g, ' ')
                .replace(/-/g, ' ');

            button.textContent = prettyName;
            button.dataset.filename = prettyName;
            button.title = `T·∫£i h·ªôi tho·∫°i: ${prettyName}`;
            button.classList.add('file-button');

            button.addEventListener('click', () => {
                loadFileContent(file.download_url, button);
            });

            conversationContainer.appendChild(button);
        });
    }

    async function fetchAllFiles(path) {
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`L·ªói m·∫°ng khi truy c·∫≠p ${path}`);
            const items = await response.json();

            const promises = items.map(async (item) => {
                if (item.type === 'dir') {
                    await fetchAllFiles(item.path);
                } else if (item.type === 'file' && item.name.endsWith('.txt')) {
                    fileList.push({
                        path: item.path,
                        download_url: item.download_url
                    });
                }
            });

            await Promise.all(promises);
        } catch (error) {
            console.error(error);
            if (conversationContainer) {
                conversationContainer.innerHTML = `<p style="color: red;">L·ªói: Kh√¥ng th·ªÉ t·∫£i danh s√°ch h·ªôi tho·∫°i t·ª´ GitHub.</p>`;
            }
        }
    }

    if (conversationContainer && dialogueInput) {
        fetchAllFiles(baseFolderPath).then(() => {
            renderFileList();
        });
    }
    // --- K·∫æT TH√öC PH·∫¶N T·∫¢I H·ªòI THO·∫†I ---


    // --- B·∫ÆT ƒê·∫¶U PH·∫¶N LUY·ªÜN N√ìI C·ª¶A B·∫†N ---
    // --- 1. L·∫•y c√°c ph·∫ßn t·ª≠ HTML ---
    const loadBtn = document.getElementById('load-btn');
    const swapRolesBtn = document.getElementById('swap-roles-btn');
    const toggleBtn = document.getElementById('toggle-line-btn');
    const recordBtn = document.getElementById('record-btn');
    const practiceArea = document.getElementById('practice-area');
    const computerLine = document.getElementById('computer-line');
    const userLine = document.getElementById('user-line');
    const userLineTitle = document.getElementById('user-line-title');
    const statusArea = document.getElementById('status-area');
    const initialSetup = document.getElementById('initial-setup');
    const sessionControlsArea = document.getElementById('session-controls-area');
    const reviewArea = document.getElementById('review-area');
    const reviewContent = document.getElementById('review-content');
    const playAllBtn = document.getElementById('play-all-btn');
    const restartSessionBtn = document.getElementById('restart-session-btn');
    const chooseNewBtn = document.getElementById('choose-new-btn');
    const rewardsInput = document.getElementById('rewards-input');
    const penaltiesInput = document.getElementById('penalties-input');
    const scoreArea = document.getElementById('score-area');
    const canvas = document.getElementById('audio-canvas');
    const canvasCtx = canvas.getContext('2d');
    const autoRecordCheckbox = document.getElementById('auto-record');
    const interimTranscriptArea = document.getElementById('interim-transcript-area');
    const successAudioInput = document.getElementById('success-audio');
    const failureAudioInput = document.getElementById('failure-audio');

    // --- 2. Kh·ªüi t·∫°o Web API & Bi·∫øn tr·∫°ng th√°i ---
    let linesA = [];
    let linesB = [];
    let userIsB = true; // Ng∆∞·ªùi d√πng m·∫∑c ƒë·ªãnh l√† B
    let currentLineIndex = 0;
    let score = 100;
    let userRecordings = []; // M·∫£ng l∆∞u c√°c b·∫£n ghi √¢m c·ªßa ng∆∞·ªùi d√πng
    let isRecording = false;
    let successAudioURL = null;
    let failureAudioURL = null;
    let currentFailureAudio = null;

    // --- C√ÅC H√ÄM TI·ªÜN √çCH ---
    function getRandomItem(textareaValue) {
        const items = textareaValue.split('\n').filter(item => item.trim() !== '');
        return items[Math.floor(Math.random() * items.length)] || '';
    }

    function updateScoreDisplay() {
        scoreArea.textContent = `ƒêi·ªÉm: ${score}`;
    }

    function speak(text, onEndCallback) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'de-DE';
            utterance.rate = 0.9;
            utterance.onend = onEndCallback;
            window.speechSynthesis.speak(utterance);
        } else {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Text-to-Speech.");
            onEndCallback();
        }
    }

    // --- C√ÅC H√ÄM CH√çNH C·ª¶A ·ª®NG D·ª§NG (B·ªî SUNG) ---

    // H√†m ƒë·ªïi vai
    swapRolesBtn.addEventListener('click', () => {
        userIsB = !userIsB;
        swapRolesBtn.textContent = userIsB ? 'üîÅ ƒê·ªïi Vai (Hi·ªán t·∫°i: B·∫°n l√† B)' : 'üîÅ ƒê·ªïi Vai (Hi·ªán t·∫°i: B·∫°n l√† A)';
    });
    
    // H√†m b·∫Øt ƒë·∫ßu luy·ªán t·∫≠p
    loadBtn.addEventListener('click', () => {
        startPractice();
    });

    function startPractice() {
        const dialogueText = dialogueInput.value.trim();
        if (!dialogueText) {
            alert('Vui l√≤ng nh·∫≠p ho·∫∑c ch·ªçn m·ªôt h·ªôi tho·∫°i!');
            return;
        }

        // Reset l·∫°i tr·∫°ng th√°i
        linesA = [];
        linesB = [];
        userRecordings = [];
        currentLineIndex = 0;
        score = 100;
        updateScoreDisplay();

        // X·ª≠ l√Ω v√† t√°ch l·ªùi tho·∫°i
        const allLines = dialogueText.split('\n').filter(line => line.trim() !== '');
        allLines.forEach(line => {
            if (line.toLowerCase().startsWith('a:')) {
                linesA.push(line.substring(2).trim());
            } else if (line.toLowerCase().startsWith('b:')) {
                linesB.push(line.substring(2).trim());
            }
        });
        
        if (linesA.length === 0 && linesB.length === 0) {
            alert('ƒê·ªãnh d·∫°ng h·ªôi tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng d√πng "A:" v√† "B:"');
            return;
        }

        // ·∫®n/hi·ªán c√°c khu v·ª±c
        initialSetup.style.display = 'none';
        reviewArea.style.display = 'none';
        if (conversationContainer) {
            conversationContainer.style.display = 'none';
        }
        practiceArea.style.display = 'block';
        sessionControlsArea.style.display = 'block';
        statusArea.innerHTML = '';
        statusArea.className = 'status';
        toggleBtn.disabled = false;
        toggleBtn.textContent = 'üôà Hi·ªán L·ªùi Tho·∫°i';
        userLine.style.display = 'none';

        // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p h·ªôi tho·∫°i
        if (userIsB) {
            // N·∫øu ng∆∞·ªùi d√πng l√† B, m√°y (A) n√≥i tr∆∞·ªõc
            statusArea.textContent = 'M√°y ƒëang n√≥i...';
            recordBtn.disabled = true;
            updateDialogueDisplay();
            speak(linesA[currentLineIndex], handleNextTurn);
        } else {
            // N·∫øu ng∆∞·ªùi d√πng l√† A, ƒë·∫øn l∆∞·ª£t ng∆∞·ªùi d√πng n√≥i tr∆∞·ªõc
            updateDialogueDisplay();
            handleNextTurn();
        }
    }
    
    function updateDialogueDisplay() {
        const computerText = userIsB ? (linesA[currentLineIndex] || '...') : (linesB[currentLineIndex] || '...');
        const userText = userIsB ? (linesB[currentLineIndex] || 'K·∫øt th√∫c') : (linesA[currentLineIndex] || 'K·∫øt th√∫c');

        computerLine.textContent = computerText;
        userLine.textContent = userText;
        
        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ cho d·ªÖ hi·ªÉu
        userLineTitle.textContent = userIsB ? "C√¢u c·ªßa b·∫°n (vai B):" : "C√¢u c·ªßa b·∫°n (vai A):";
    }
    
    // N√∫t ·∫©n/hi·ªán l·ªùi tho·∫°i
    toggleBtn.addEventListener('click', () => {
        const isHidden = userLine.style.display === 'none';
        userLine.style.display = isHidden ? 'block' : 'none';
        toggleBtn.textContent = isHidden ? 'üôâ ·∫®n L·ªùi Tho·∫°i' : 'üôà Hi·ªán L·ªùi Tho·∫°i';
    });


    // --- PH·∫¶N GHI √ÇM V√Ä X·ª¨ L√ù K·∫æT QU·∫¢ ---
    function openTranslatePopup() {
        // C·∫ßn c·∫≠p nh·∫≠t l·ªùi tho·∫°i tr∆∞·ªõc khi m·ªü popup
        updateDialogueDisplay(); 
        
        const popup = window.open(
            "translate-popup.html",
            "translatePopup",
            "width=500,height=400"
        );
        
        if (!popup) {
            alert("Vui l√≤ng cho ph√©p m·ªü c·ª≠a s·ªï pop-up ƒë·ªÉ ghi √¢m.");
            return;
        }

        // Nh·∫≠n transcript t·ª´ popup
        const messageHandler = (event) => {
            // Ch·ªâ ch·∫•p nh·∫≠n message t·ª´ popup v·ª´a m·ªü
            if (event.source !== popup) {
                return;
            }
            if (event.data && event.data.transcript) {
                const spokenText = event.data.transcript.trim();
                console.log("Nh·∫≠n t·ª´ popup:", spokenText);
                processFinalResult(spokenText); // G·ªçi h√†m ch·∫•m ƒëi·ªÉm c≈©
                window.removeEventListener("message", messageHandler); // D·ªçn d·∫πp listener
            }
        };
        
        window.addEventListener("message", messageHandler);
    }

    recordBtn.addEventListener('click', openTranslatePopup);
    
    function handleNextTurn() {
        updateDialogueDisplay();
        const userText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];

        if (userText) {
             if (autoRecordCheckbox.checked) {
                statusArea.textContent = 'ƒê·∫øn l∆∞·ª£t b·∫°n. Chu·∫©n b·ªã ghi √¢m...';
                setTimeout(openTranslatePopup, 1000); // M·ªü popup t·ª± ƒë·ªông
            } else {
                statusArea.textContent = 'ƒê·∫øn l∆∞·ª£t b·∫°n. H√£y nh·∫•n n√∫t ƒë·ªÉ ghi √¢m.';
                recordBtn.disabled = false;
                recordBtn.textContent = 'üé§ B·∫Øt ƒê·∫ßu Ghi √Çm';
            }
        } else {
            // ƒê√£ h·∫øt l·ªùi tho·∫°i c·ªßa ng∆∞·ªùi d√πng -> k·∫øt th√∫c
            setTimeout(showReview, 1000);
        }
    }
    
    // H√†m so s√°nh vƒÉn b·∫£n (dummy, c·∫ßn m·ªôt th∆∞ vi·ªán t·ªët h∆°n nh∆∞ diff-match-patch)
    function createDiffHtml(original, spoken) {
        // ƒê√¢y l√† m·ªôt phi√™n b·∫£n ƒë∆°n gi·∫£n h√≥a ƒë·ªÉ t√≠nh ƒë·ªô ch√≠nh x√°c
        const originalWords = original.toLowerCase().split(/\s+/);
        const spokenWords = spoken.toLowerCase().split(/\s+/);
        let correctWords = 0;
        originalWords.forEach(word => {
            if (spokenWords.includes(word)) {
                correctWords++;
            }
        });
        const accuracy = originalWords.length > 0 ? Math.round((correctWords / originalWords.length) * 100) : 100;
        // Ph·∫ßn t·∫°o HTML ƒë·ªÉ so s√°nh chi ti·∫øt c√≥ th·ªÉ ph·ª©c t·∫°p, t·∫°m th·ªùi b·ªè qua ƒë·ªÉ ƒë∆°n gi·∫£n
        return {
            html: `B·∫°n n√≥i: "${spoken}"<br>C·∫ßn n√≥i: "${original}"`,
            accuracy: accuracy
        };
    }
    
    async function processFinalResult(spokenText) {
        const targetText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
        if (!targetText) return;

        const difficultyThreshold = parseInt(document.querySelector('input[name="difficulty"]:checked').value);
        const { html: diffHtml, accuracy } = createDiffHtml(targetText, spokenText);
        
        // L∆∞u l·∫°i b·∫£n ghi √¢m (c·∫ßn b·ªï sung logic n√†y n·∫øu mu·ªën)
        // userRecordings[currentLineIndex] = lastAudioBlob;

        if (accuracy >= difficultyThreshold) {
            statusArea.className = 'status success';
            const rewardMsg = getRandomItem(rewardsInput.value);
            statusArea.innerHTML = `${rewardMsg} (ƒê·ªô ch√≠nh x√°c: ${accuracy}%)`;
            
            if(successAudioURL) await new Audio(successAudioURL).play();

            currentLineIndex++;
            const conversationLength = Math.max(linesA.length, linesB.length);

            if (currentLineIndex >= conversationLength) {
                setTimeout(showReview, 1000);
                return;
            }

            const nextLineToSpeak = userIsB ? linesA[currentLineIndex] : linesB[currentLineIndex];

            if (nextLineToSpeak) {
                statusArea.textContent = 'M√°y ƒëang n√≥i...';
                recordBtn.disabled = true;
                recordBtn.textContent = '...';
                speak(nextLineToSpeak, handleNextTurn);
            } else {
                // H·∫øt l·ªùi tho·∫°i c·ªßa m√°y, nh∆∞ng v·∫´n c√≤n l·ªùi c·ªßa ng∆∞·ªùi d√πng
                handleNextTurn();
            }
        } else {
            statusArea.className = 'status error';
            score -= 5;
            updateScoreDisplay();
            const penaltyMsg = getRandomItem(penaltiesInput.value);
            statusArea.innerHTML = `<div style="margin-bottom: 10px;">${penaltyMsg} (${accuracy}%). Th·ª≠ l·∫°i nh√©! (-5 ƒëi·ªÉm)</div><div class="feedback-box">${diffHtml}</div>`;
            
            if (failureAudioURL) {
                if (currentFailureAudio) { currentFailureAudio.pause(); }
                currentFailureAudio = new Audio(failureAudioURL);
                currentFailureAudio.play();
            }
            
            recordBtn.disabled = false;
            recordBtn.textContent = 'üé§ Th·ª≠ L·∫°i';
        }
    }
    
    function showReview() {
        practiceArea.style.display = 'none';
        sessionControlsArea.style.display = 'none';
        reviewArea.style.display = 'block';
        statusArea.innerHTML = 'üéâ Ho√†n th√†nh h·ªôi tho·∫°i! üéâ';
        statusArea.className = 'status success';
        
        reviewContent.innerHTML = '';
        const conversationLength = Math.max(linesA.length, linesB.length);

        for (let i = 0; i < conversationLength; i++) {
            const lineA = linesA[i];
            const lineB = linesB[i];
            
            if (lineA) {
                const div = document.createElement('div');
                div.className = userIsB ? 'review-line computer' : 'review-line user';
                div.textContent = `A: ${lineA}`;
                reviewContent.appendChild(div);
            }
            if (lineB) {
                 const div = document.createElement('div');
                div.className = userIsB ? 'review-line user' : 'review-line computer';
                div.textContent = `B: ${lineB}`;
                reviewContent.appendChild(div);
            }
        }
    }


    // --- S·ª∞ KI·ªÜN CHO C√ÅC N√öT KH√ÅC ---
    restartSessionBtn.addEventListener('click', () => {
        startPractice();
    });

    chooseNewBtn.addEventListener('click', () => {
        reviewArea.style.display = 'none';
        initialSetup.style.display = 'block';
        practiceArea.style.display = 'none';
        sessionControlsArea.style.display = 'none';
        canvas.style.display = 'none';
        statusArea.innerHTML = '';
        statusArea.className = 'status';
        dialogueInput.value = '';
        linesA = [];
        linesB = [];
        userRecordings = [];
        currentLineIndex = 0;
        score = 100;
        updateScoreDisplay();
        if (conversationContainer) {
            conversationContainer.style.display = 'block';
        }
    });

    playAllBtn.addEventListener('click', async () => {
        playAllBtn.disabled = true;
        // Logic ph√°t l·∫°i to√†n b·ªô h·ªôi tho·∫°i (c·∫ßn c√≥ b·∫£n ghi √¢m)
        alert("Ch·ª©c nƒÉng nghe l·∫°i to√†n b·ªô ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!");
        playAllBtn.disabled = false;
    });

    successAudioInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            if (successAudioURL) URL.revokeObjectURL(successAudioURL);
            successAudioURL = URL.createObjectURL(file);
        }
    });

    failureAudioInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            if (failureAudioURL) URL.revokeObjectURL(failureAudioURL);
            failureAudioURL = URL.createObjectURL(file);
        }
    });
});
    </script>
</body>
</html>
