<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán N√≥i Ti·∫øng ƒê·ª©c Pro - N√¢ng C·∫•p</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
        }
        h1 { color: #0d6efd; margin-bottom: 25px; }
        h2 { font-size: 1.2rem; color: #495057; margin-bottom: 10px; text-align: left; border-bottom: 1px solid #dee2e6; padding-bottom: 5px; }
        textarea {
            width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid #ced4da; border-radius: 8px;
            font-size: 1rem; margin-bottom: 10px; resize: vertical;
        }
        button {
            background-color: #0d6efd; color: white; border: none; padding: 12px 24px; border-radius: 8px;
            font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #0b5ed7; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button#record-btn { background-color: #198754; }
        button#record-btn:hover { background-color: #157347; }
        .dialogue-box { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; text-align: left; }
        .line { padding: 12px; margin: 8px 0; border-radius: 8px; font-size: 1.1rem; }
        .computer-line { background-color: #e7f3ff; }
        .user-line { background-color: #fff3cd; font-weight: bold; border: 2px dashed #ffc107; }
        .status { margin-top: 20px; font-size: 1.1rem; font-weight: bold; min-height: 50px; padding: 10px; border-radius: 8px;}
        .status.success { color: #146c43; background-color: #d1e7dd; }
        .status.error { color: #b02a37; background-color: #f8d7da; }
        #score-area {
            position: fixed; top: 20px; right: 20px; background-color: #ffc107; color: #333;
            padding: 10px 20px; border-radius: 20px; font-size: 1.2rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="score-area">ƒêi·ªÉm: 100</div>
    <div class="container">
        <h1>Luy·ªán Giao Ti·∫øp Chuy√™n Nghi·ªáp üöÄ</h1>

        <textarea id="dialogue-input" rows="6" placeholder="D√°n h·ªôi tho·∫°i ·ªü ƒë√¢y...&#10;V√≠ d·ª•:&#10;A: Hallo, wie geht's?&#10;B: Mir geht's gut, danke."></textarea>
        <div class="controls">
            <button id="load-btn">üöÄ B·∫Øt ƒê·∫ßu Luy·ªán T·∫≠p</button>
        </div>

        <div id="practice-area" class="dialogue-box" style="display:none;">
            <h2>L·ªùi tho·∫°i c·ªßa m√°y:</h2>
            <div id="computer-line" class="line computer-line">...</div>
            <div id="user-line-container">
                <h2>C√¢u c·ªßa b·∫°n:</h2>
                <div id="user-line" class="line user-line">...</div>
            </div>
        </div>

        <div id="status-area" class="status"></div>
        <div class="session-controls" style="margin-top:15px;">
            <button id="record-btn" disabled>üé§ B·∫Øt ƒê·∫ßu N√≥i</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadBtn = document.getElementById('load-btn');
        const recordBtn = document.getElementById('record-btn');
        const dialogueInput = document.getElementById('dialogue-input');
        const computerLine = document.getElementById('computer-line');
        const userLine = document.getElementById('user-line');
        const statusArea = document.getElementById('status-area');
        const scoreArea = document.getElementById('score-area');

        let linesA = [], linesB = [], currentLineIndex = 0;
        let score = 100;
        let userIsB = true;

        // H√†m t√≠nh ƒë·ªô ch√≠nh x√°c
        function calcAccuracy(original, spoken) {
            const clean = str => str.toLowerCase().replace(/[^\w\s√§√∂√º√ü]/g, "").split(/\s+/).filter(Boolean);
            const origWords = clean(original);
            const spokenWords = clean(spoken);
            const correct = spokenWords.filter(w => origWords.includes(w)).length;
            return Math.round((correct / origWords.length) * 100);
        }

        // Ch·∫•m ƒëi·ªÉm khi nh·∫≠n transcript
        function processFinalResult(spokenText) {
            const targetText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
            const accuracy = calcAccuracy(targetText, spokenText);
            if (accuracy >= 80) {
                statusArea.className = "status success";
                statusArea.innerText = `üëç ƒê√∫ng ${accuracy}%!`;
                currentLineIndex++;
                nextTurn();
            } else {
                statusArea.className = "status error";
                statusArea.innerText = `üò• Ch·ªâ ${accuracy}%. Th·ª≠ l·∫°i nh√©!`;
                score -= 5;
                scoreArea.innerText = `ƒêi·ªÉm: ${score}`;
            }
        }

        function nextTurn() {
            const conversationLength = Math.max(linesA.length, linesB.length);
            if (currentLineIndex >= conversationLength) {
                statusArea.className = "status success";
                statusArea.innerText = `üéâ Ho√†n th√†nh h·ªôi tho·∫°i! ƒêi·ªÉm: ${score}`;
                recordBtn.disabled = true;
                return;
            }
            const compText = userIsB ? linesA[currentLineIndex] : linesB[currentLineIndex];
            const usrText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
            computerLine.innerText = compText || "...";
            userLine.innerText = usrText || "...";
            recordBtn.disabled = false;
            statusArea.innerText = "ƒê·∫øn l∆∞·ª£t b·∫°n n√≥i...";
        }

        function openTranslatePopup() {
            const popup = window.open(
                "translate-popup.html",
                "translatePopup",
                "width=500,height=400"
            );
            window.addEventListener("message", (event) => {
                if (event.data && event.data.transcript) {
                    const spoken = event.data.transcript.trim();
                    processFinalResult(spoken);
                }
            }, { once: true });
        }

        recordBtn.addEventListener('click', openTranslatePopup);

        loadBtn.addEventListener('click', () => {
            const fullText = dialogueInput.value.trim();
            if (!fullText) { alert("Vui l√≤ng nh·∫≠p ƒëo·∫°n h·ªôi tho·∫°i!"); return; }
            linesA = []; linesB = [];
            fullText.split("\n").forEach(line => {
                if (line.toLowerCase().startsWith("a:")) linesA.push(line.substring(2).trim());
                if (line.toLowerCase().startsWith("b:")) linesB.push(line.substring(2).trim());
            });
            if (!linesA.length && !linesB.length) {
                alert("Kh√¥ng c√≥ c√¢u tho·∫°i h·ª£p l·ªá!"); return;
            }
            currentLineIndex = 0;
            score = 100;
            scoreArea.innerText = `ƒêi·ªÉm: ${score}`;
            document.getElementById('practice-area').style.display = "block";
            recordBtn.disabled = false;
            nextTurn();
        });
    });
    </script>
</body>
</html>
