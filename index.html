<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luy·ªán N√≥i Ti·∫øng ƒê·ª©c Pro ‚Äî Popup Google D·ªãch (C√°ch 2)</title>
  <style>
    :root { --primary:#0d6efd; --accent:#ffc107; --ok:#198754; --error:#dc3545; }
    *{ box-sizing:border-box }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:#f0f2f5; color:#1c1e21; margin:0; padding:24px;
      display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
    }
    .container{
      width:100%; max-width:760px; background:#fff; border-radius:14px; padding:28px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    h1{ margin:0 0 16px; color:var(--primary); }
    h2{ font-size:1.1rem; color:#495057; margin:22px 0 8px; border-bottom:1px solid #e9ecef; padding-bottom:6px;}
    textarea{
      width:100%; padding:12px; border:1px solid #ced4da; border-radius:10px; font-size:1rem; resize:vertical;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0; }
    button{
      border:0; background:var(--primary); color:#fff; padding:10px 18px; border-radius:9px;
      font-weight:600; cursor:pointer; transition:.2s; box-shadow:0 2px 5px rgba(0,0,0,.08);
    }
    button:hover{ transform:translateY(-1px); filter:brightness(0.95); }
    button.secondary{ background:#6c757d; }
    button.ghost{ background:#e9ecef; color:#333; }
    .dialogue-box{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:14px; }
    .line{ padding:10px; margin:8px 0; border-radius:10px; font-size:1.05rem; }
    .computer-line{ background:#e7f3ff; }
    .user-line{ background:#fff3cd; font-weight:600; border:2px dashed var(--accent); }
    .status{ margin-top:14px; font-weight:700; padding:12px; border-radius:10px; min-height:48px; }
    .status.success{ background:#d1e7dd; color:#146c43; }
    .status.error{ background:#f8d7da; color:#b02a37; }
    .status.neutral{ background:#eef; color:#334; }
    .feedback-box{
      font-size:1rem; background:#f8f9fa; border:1px solid #ddd; border-radius:10px; padding:14px; line-height:1.7; margin-top:10px;
    }
    #score-area{
      position:fixed; top:18px; right:18px; background:var(--accent); color:#333;
      padding:8px 14px; border-radius:20px; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
  </style>
</head>
<body>
<div id="score-area">ƒêi·ªÉm: 100</div>
<div class="container">
  <h1>Luy·ªán Giao Ti·∫øp Chuy√™n Nghi·ªáp üöÄ</h1>

  <div id="initial-setup">
    <textarea id="dialogue-input" rows="6" placeholder="D√°n h·ªôi tho·∫°i ·ªü ƒë√¢y...
V√≠ d·ª•:
A: Hallo, wie geht's?
B: Mir geht's gut, danke."></textarea>

    <div class="controls">
      <button id="load-btn">üöÄ B·∫Øt ƒê·∫ßu Luy·ªán T·∫≠p</button>
      <button id="swap-roles-btn" class="ghost">üîÅ ƒê·ªïi Vai (Hi·ªán t·∫°i: B·∫°n l√† B)</button>
      <button id="toggle-line-btn" class="ghost" disabled>üôà Hi·ªán L·ªùi Tho·∫°i</button>
    </div>
  </div>

  <div id="practice-area" class="dialogue-box" style="display:none;">
    <h2>L·ªùi tho·∫°i c·ªßa m√°y:</h2>
    <div id="computer-line" class="line computer-line">...</div>
    <div>
      <h2 id="user-line-title">C√¢u c·ªßa b·∫°n:</h2>
      <div id="user-line" class="line user-line" style="display:none;">...</div>
    </div>
  </div>

  <div id="status-area" class="status neutral"></div>

  <div id="review-area" style="display:none;">
    <h2>Xem L·∫°i H·ªôi Tho·∫°i</h2>
    <div id="review-content"></div>
    <div class="controls" style="margin-top: 10px;">
      <button id="restart-session-btn" class="secondary">üîÅ Luy·ªán l·∫°i</button>
      <button id="choose-new-btn" class="secondary">üè† Ch·ªçn m·ªõi</button>
    </div>
  </div>
</div>

<script>
let linesA=[], linesB=[], currentLineIndex=0, userIsB=true, isUserLineVisible=false;
let score=100;
const scoreArea=document.getElementById('score-area');
const statusArea=document.getElementById('status-area');
const userLineEl=document.getElementById('user-line');
const userLineTitle=document.getElementById('user-line-title');
const toggleBtn=document.getElementById('toggle-line-btn');

// Gi·ªçng m√°y ƒë·ªçc
const synth=window.speechSynthesis; let voices=[];
function loadVoices(){voices=synth.getVoices();}
loadVoices(); if(synth.onvoiceschanged!==undefined){synth.onvoiceschanged=loadVoices;}
function speak(text,cb){ if(synth.speaking) synth.cancel(); const u=new SpeechSynthesisUtterance(text); u.voice=voices.find(v=>v.lang?.startsWith('de')); u.onend=()=>cb&&cb(); synth.speak(u); }

// === Popup qu·∫£n l√Ω ===
let translatePopup=null;
function ensurePopup(){
  if(!translatePopup || translatePopup.closed){
    translatePopup=window.open("","gt_popup","width=560,height=420");
    translatePopup.document.write("<html><head><title>Popup s·∫µn s√†ng</title></head><body><p>Popup ƒë√£ m·ªü s·∫µn, ƒë·ª£i t·ªõi l∆∞·ª£t b·∫°n...</p></body></html>");
  }
}
function openTranslatePopup(){
  if(!translatePopup || translatePopup.closed){ alert("Popup ƒë√£ ƒë√≥ng, h√£y nh·∫•n F5 ƒë·ªÉ m·ªü l·∫°i."); return; }
  const popupHtml = `<!doctype html><html lang="vi"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Google D·ªãch</title></head><body>
  <h3>Google D·ªãch ‚Äî Nh·∫≠n Transcript</h3>
  <p>1) Nh·∫•n <a target="_blank" href="https://translate.google.com/?sl=de&tl=vi&op=translate">M·ªü Google D·ªãch</a> v√† n√≥i b·∫±ng ti·∫øng ƒê·ª©c.</p>
  <p>2) Sao ch√©p vƒÉn b·∫£n ti·∫øng ƒê·ª©c (√¥ b√™n tr√°i).</p>
  <p>3) Quay l·∫°i ƒë√¢y v√† b·∫•m n√∫t.</p>
  <button id="pasteSendBtn">üìã L·∫•y t·ª´ Clipboard & G·ª≠i</button>
  <script>
    const openerOrigin="*";
    document.getElementById('pasteSendBtn').addEventListener('click',async()=>{
      try{
        const text=await navigator.clipboard.readText();
        if(!text.trim()){alert("Clipboard tr·ªëng.");return;}
        window.opener.postMessage({type:'GT_TRANSCRIPT',payload:text.trim()},openerOrigin);
      }catch(e){alert("L·ªói clipboard: "+e.message);}
    });
  </scr`+`ipt></body></html>`;
  translatePopup.document.open(); translatePopup.document.write(popupHtml); translatePopup.document.close();
}
window.addEventListener('message',ev=>{
  const {type,payload}=ev.data||{};
  if(type==='GT_TRANSCRIPT'){ processSpokenText(String(payload||'')); }
});

// So s√°nh
function lcs(a,b){const m=a.length,n=b.length;const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);}}let i=m,j=n,res=[];while(i>0&&j>0){if(a[i-1]===b[j-1]){res.unshift(a[i-1]);i--;j--;}else if(dp[i-1][j]>dp[i][j-1])i--;else j--;}return res;}
function createDiffHtml(originalText,spokenText){const clean=t=>t.toLowerCase().replace(/[^\w\s'√§√∂√º√ü]/g,'').split(/\s+/).filter(Boolean);const original=clean(originalText),spoken=clean(spokenText);const common=new Set(lcs(original,spoken));let correct=0;const spokenHtml=spoken.map(w=>{if(common.has(w)){correct++;return '<b>'+w+'</b>';}return '<span style="color:red">'+w+'</span>';}).join(' ');const originalHtml=original.map(w=>common.has(w)?w:'<i>'+w+'</i>').join(' ');const accuracy=original.length?Math.round((correct/original.length)*100):0;return {html:`<div><b>C√¢u g·ªëc:</b> ${originalHtml}</div><div><b>B·∫°n n√≥i:</b> ${spokenHtml}</div>`,accuracy};}

// Lu·ªìng ch√≠nh
function updateScore(){scoreArea.textContent='ƒêi·ªÉm: '+score;}
function updateDialogueDisplay(){const computerRole=userIsB?'A':'B';const userRole=userIsB?'B':'A';const computerText=userIsB?linesA[currentLineIndex]:linesB[currentLineIndex];const userText=userIsB?linesB[currentLineIndex]:linesA[currentLineIndex];document.getElementById('computer-line').textContent=`${computerRole} (M√°y): ${computerText||'...'}`;userLineEl.textContent=userText||'...';userLineTitle.textContent=`C√¢u c·ªßa b·∫°n (${userRole}):`;userLineEl.style.display=isUserLineVisible?'block':'none';toggleBtn.textContent=isUserLineVisible?'·∫®n':'Hi·ªán';}
function startPractice(){currentLineIndex=0;score=100;updateScore();document.getElementById('initial-setup').style.display='none';document.getElementById('practice-area').style.display='block';ensurePopup();updateDialogueDisplay();statusArea.textContent='M√°y ƒëang n√≥i...';const next=userIsB?linesA[0]:linesB[0];if(next){speak(next,()=>handleNextTurn());}else{handleNextTurn();}}
function handleNextTurn(){const userText=userIsB?linesB[currentLineIndex]:linesA[currentLineIndex];if(userText){statusArea.textContent='ƒê·∫øn l∆∞·ª£t b·∫°n. H√£y d√πng popup Google D·ªãch.';openTranslatePopup();}else{currentLineIndex++;if(currentLineIndex>=Math.max(linesA.length,linesB.length)){showReview();return;}const next=userIsB?linesA[currentLineIndex]:linesB[currentLineIndex];if(next){speak(next,()=>handleNextTurn());}else{showReview();}}}
function processSpokenText(spokenText){const targetText=userIsB?(linesB[currentLineIndex]||''):(linesA[currentLineIndex]||'');const {html,accuracy}=createDiffHtml(targetText,spokenText);if(accuracy>=90){statusArea.className='status success';statusArea.innerHTML='T·ªët l·∫Øm! '+accuracy+'%';currentLineIndex++;if(currentLineIndex>=Math.max(linesA.length,linesB.length)){showReview();return;}updateDialogueDisplay();const next=userIsB?linesA[currentLineIndex]:linesB[currentLineIndex];if(next){speak(next,()=>handleNextTurn());}else{handleNextTurn();}}else{statusArea.className='status error';score=Math.max(0,score-5);updateScore();statusArea.innerHTML='Ch∆∞a ƒë·∫°t ('+accuracy+'%). Th·ª≠ l·∫°i.<br>'+html;openTranslatePopup();}}
function showReview(){document.getElementById('practice-area').style.display='none';document.getElementById('review-area').style.display='block';statusArea.textContent='K·∫øt th√∫c. ƒêi·ªÉm: '+score;}

// N√∫t ƒëi·ªÅu khi·ªÉn
document.getElementById('load-btn').addEventListener('click',()=>{const full=(document.getElementById('dialogue-input').value||'').trim();if(!full){alert('Nh·∫≠p h·ªôi tho·∫°i!');return;}const lines=full.split('\n').filter(x=>x.trim()!=='');linesA=[];linesB=[];lines.forEach(l=>{if(/^a:/i.test(l))linesA.push(l.slice(2).trim());else if(/^b:/i.test(l))linesB.push(l.slice(2).trim());});startPractice();});
document.getElementById('swap-roles-btn').addEventListener('click',()=>{userIsB=!userIsB;});
document.getElementById('toggle-line-btn').addEventListener('click',()=>{isUserLineVisible=!isUserLineVisible;updateDialogueDisplay();});
</script>
</body>
</html>
