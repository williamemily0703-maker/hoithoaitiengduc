<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luyá»‡n NÃ³i Tiáº¿ng Äá»©c Pro - NÃ¢ng Cáº¥p</title>
  <style>
    /* giá»¯ nguyÃªn CSS cÅ© */
  </style>
</head>
<body>
  <div id="score-area">Äiá»ƒm: 100</div>
  <div class="container">
    <h1>Luyá»‡n Giao Tiáº¿p ChuyÃªn Nghiá»‡p ğŸš€</h1>
    <!-- giá»¯ nguyÃªn pháº§n HTML cÅ© -->
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function() {
    // --- giá»¯ nguyÃªn cÃ¡c biáº¿n cÅ©, CHá»ˆ Bá» recognition ---
    const loadBtn = document.getElementById('load-btn');
    const swapRolesBtn = document.getElementById('swap-roles-btn');
    const toggleBtn = document.getElementById('toggle-line-btn');
    const recordBtn = document.getElementById('record-btn');
    const practiceArea = document.getElementById('practice-area');
    const computerLine = document.getElementById('computer-line');
    const userLine = document.getElementById('user-line');
    const userLineTitle = document.getElementById('user-line-title');
    const statusArea = document.getElementById('status-area');
    const initialSetup = document.getElementById('initial-setup');
    const sessionControlsArea = document.getElementById('session-controls-area');
    const reviewArea = document.getElementById('review-area');
    const reviewContent = document.getElementById('review-content');
    const playAllBtn = document.getElementById('play-all-btn');
    const restartSessionBtn = document.getElementById('restart-session-btn');
    const chooseNewBtn = document.getElementById('choose-new-btn');
    const rewardsInput = document.getElementById('rewards-input');
    const penaltiesInput = document.getElementById('penalties-input');
    const scoreArea = document.getElementById('score-area');
    const autoRecordCheckbox = document.getElementById('auto-record');

    let linesA = [], linesB = [], userRecordings = [];
    let currentLineIndex = 0;
    let userIsB = true;
    let isUserLineVisible = false;
    let score = 100;

    // --- Giá»¯ láº¡i cÃ¡c hÃ m cÅ©: speak, playAudioPromise, lcs, createDiffHtml, updateDialogueDisplay, showReview, updateScoreDisplay, getRandomItem ---
    // (khÃ´ng dÃ¡n láº¡i toÃ n bá»™ cho gá»n, nhÆ°ng báº¡n giá»¯ nguyÃªn)

    function openGoogleTranslatePopup() {
      window.open(
        "popup.html",
        "gtPopup",
        "width=600,height=600"
      );
    }

    function startRecording() {
      statusArea.textContent = 'Má»Ÿ Google Translate Ä‘á»ƒ báº¡n nÃ³i...';
      recordBtn.disabled = true;
      recordBtn.textContent = 'ğŸ”´ Äang má»Ÿ popup...';
      openGoogleTranslatePopup();
    }

    // Nháº­n transcript tá»« popup
    window.addEventListener("message", (event) => {
      if (!event.data) return;
      if (event.data.type === "gt_transcript") {
        const transcript = event.data.text;
        processFinalResult(transcript);
      }
    });

    async function processFinalResult(spokenText) {
      const targetText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
      const difficultyThreshold = parseInt(document.querySelector('input[name="difficulty"]:checked').value);
      const { html: diffHtml, accuracy } = createDiffHtml(targetText, spokenText.trim());

      if (accuracy >= difficultyThreshold) {
        statusArea.className = 'status success';
        const rewardMsg = getRandomItem(rewardsInput.value);
        statusArea.innerHTML = `${rewardMsg} (Äá»™ chÃ­nh xÃ¡c: ${accuracy}%)`;
        currentLineIndex++;
        const conversationLength = Math.max(linesA.length, linesB.length);
        if (currentLineIndex >= conversationLength) {
          setTimeout(showReview, 1000);
          return;
        }
        updateDialogueDisplay();
        const nextLineToSpeak = userIsB ? linesA[currentLineIndex] : (linesB[currentLineIndex] || null);
        if (nextLineToSpeak) {
          statusArea.textContent = 'MÃ¡y Ä‘ang nÃ³i...';
          recordBtn.disabled = true;
          recordBtn.textContent = '...';
          const speakPromise = new Promise(resolve => speak(nextLineToSpeak, resolve));
          await speakPromise;
          handleNextTurn();
        } else {
          handleNextTurn();
        }
      } else {
        statusArea.className = 'status error';
        score -= 5;
        updateScoreDisplay();
        const penaltyMsg = getRandomItem(penaltiesInput.value);
        statusArea.innerHTML = `<div style="margin-bottom: 10px;">${penaltyMsg} (${accuracy}%). Thá»­ láº¡i nhÃ©! (-5 Ä‘iá»ƒm)</div><div class="feedback-box">${diffHtml}</div>`;
        recordBtn.disabled = false;
        recordBtn.textContent = 'ğŸ¤ Thá»­ Láº¡i';
      }
    }

    function handleNextTurn() {
      const userText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
      if (userText) {
        if (autoRecordCheckbox.checked) {
          statusArea.textContent = 'Äáº¿n lÆ°á»£t báº¡n. Chuáº©n bá»‹ má»Ÿ popup...';
          setTimeout(startRecording, 500);
        } else {
          statusArea.textContent = 'Äáº¿n lÆ°á»£t báº¡n. HÃ£y nháº¥n nÃºt Ä‘á»ƒ má»Ÿ popup.';
          recordBtn.disabled = false;
          recordBtn.textContent = 'ğŸ¤ Má»Ÿ Popup Ghi Ã‚m';
        }
      } else {
        currentLineIndex++;
        const conversationLength = Math.max(linesA.length, linesB.length);
        if (currentLineIndex >= conversationLength) {
          setTimeout(showReview, 1000);
          return;
        }
        const nextLineToSpeak = userIsB ? linesA[currentLineIndex] : linesB[currentLineIndex];
        if (nextLineToSpeak) {
          speak(nextLineToSpeak, handleNextTurn);
        } else {
          setTimeout(showReview, 1000);
        }
      }
    }

    // Giá»¯ nguyÃªn loadBtn, swapRolesBtn, toggleBtn, playAllBtn, restartSessionBtn, chooseNewBtn... (khÃ´ng thay Ä‘á»•i nhiá»u)
  });
  </script>
</body>
</html>
