<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luyện Nói Tiếng Đức Pro — Popup Google Dịch (Cách 2)</title>
  <style>
    :root { --primary:#0d6efd; --accent:#ffc107; --ok:#198754; --error:#dc3545; }
    *{ box-sizing:border-box }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:#f0f2f5; color:#1c1e21; margin:0; padding:24px;
      display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
    }
    .container{
      width:100%; max-width:760px; background:#fff; border-radius:14px; padding:28px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    h1{ margin:0 0 16px; color:var(--primary); }
    h2{ font-size:1.1rem; color:#495057; margin:22px 0 8px; border-bottom:1px solid #e9ecef; padding-bottom:6px;}
    textarea{
      width:100%; padding:12px; border:1px solid #ced4da; border-radius:10px; font-size:1rem; resize:vertical;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0; }
    button{
      border:0; background:var(--primary); color:#fff; padding:10px 18px; border-radius:9px;
      font-weight:600; cursor:pointer; transition:.2s; box-shadow:0 2px 5px rgba(0,0,0,.08);
    }
    button:hover{ transform:translateY(-1px); filter:brightness(0.95); }
    button.secondary{ background:#6c757d; }
    button.ghost{ background:#e9ecef; color:#333; }
    .dialogue-box{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:14px; }
    .line{ padding:10px; margin:8px 0; border-radius:10px; font-size:1.05rem; }
    .computer-line{ background:#e7f3ff; }
    .user-line{ background:#fff3cd; font-weight:600; border:2px dashed var(--accent); }
    .status{ margin-top:14px; font-weight:700; padding:12px; border-radius:10px; min-height:48px; }
    .status.success{ background:#d1e7dd; color:#146c43; }
    .status.error{ background:#f8d7da; color:#b02a37; }
    .status.neutral{ background:#eef; color:#334; }
    .feedback-box{
      font-size:1rem; background:#f8f9fa; border:1px solid #ddd; border-radius:10px; padding:14px; line-height:1.7; margin-top:10px;
    }
    #score-area{
      position:fixed; top:18px; right:18px; background:var(--accent); color:#333;
      padding:8px 14px; border-radius:20px; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
  </style>
</head>
<body>
<div id="score-area">Điểm: 100</div>
<div class="container">
  <h1>Luyện Giao Tiếp Chuyên Nghiệp 🚀</h1>

  <div id="initial-setup">
    <textarea id="dialogue-input" rows="6" placeholder="Dán hội thoại ở đây...
Ví dụ:
A: Hallo, wie geht's?
B: Mir geht's gut, danke."></textarea>

    <div class="controls">
      <button id="load-btn">🚀 Bắt Đầu Luyện Tập</button>
      <button id="swap-roles-btn" class="ghost">🔁 Đổi Vai (Hiện tại: Bạn là B)</button>
      <button id="toggle-line-btn" class="ghost" disabled>🙈 Hiện Lời Thoại</button>
    </div>
  </div>

  <div id="practice-area" class="dialogue-box" style="display:none;">
    <h2>Lời thoại của máy:</h2>
    <div id="computer-line" class="line computer-line">...</div>
    <div>
      <h2 id="user-line-title">Câu của bạn:</h2>
      <div id="user-line" class="line user-line" style="display:none;">...</div>
    </div>
  </div>

  <div id="status-area" class="status neutral"></div>

  <div id="review-area" style="display:none;">
    <h2>Xem Lại Hội Thoại</h2>
    <div id="review-content"></div>
    <div class="controls" style="margin-top: 10px;">
      <button id="restart-session-btn" class="secondary">🔁 Luyện lại</button>
      <button id="choose-new-btn" class="secondary">🏠 Chọn mới</button>
    </div>
  </div>
</div>

<script>
let linesA=[], linesB=[], currentLineIndex=0, userIsB=true, isUserLineVisible=false;
let score=100;
const scoreArea=document.getElementById('score-area');
const statusArea=document.getElementById('status-area');
const userLineEl=document.getElementById('user-line');
const userLineTitle=document.getElementById('user-line-title');
const toggleBtn=document.getElementById('toggle-line-btn');

// Giọng máy đọc
const synth=window.speechSynthesis; let voices=[];
function loadVoices(){voices=synth.getVoices();}
loadVoices(); if(synth.onvoiceschanged!==undefined){synth.onvoiceschanged=loadVoices;}
function speak(text,cb){ if(synth.speaking) synth.cancel(); const u=new SpeechSynthesisUtterance(text); u.voice=voices.find(v=>v.lang?.startsWith('de')); u.onend=()=>cb&&cb(); synth.speak(u); }

// === Popup quản lý ===
let translatePopup=null;
function ensurePopup(){
  if(!translatePopup || translatePopup.closed){
    translatePopup=window.open("","gt_popup","width=560,height=420");
    translatePopup.document.write("<html><head><title>Popup sẵn sàng</title></head><body><p>Popup đã mở sẵn, đợi tới lượt bạn...</p></body></html>");
  }
}
function openTranslatePopup(){
  if(!translatePopup || translatePopup.closed){ alert("Popup đã đóng, hãy nhấn F5 để mở lại."); return; }
  const popupHtml = `<!doctype html><html lang="vi"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Google Dịch</title></head><body>
  <h3>Google Dịch — Nhận Transcript</h3>
  <p>1) Nhấn <a target="_blank" href="https://translate.google.com/?sl=de&tl=vi&op=translate">Mở Google Dịch</a> và nói bằng tiếng Đức.</p>
  <p>2) Sao chép văn bản tiếng Đức (ô bên trái).</p>
  <p>3) Quay lại đây và bấm nút.</p>
  <button id="pasteSendBtn">📋 Lấy từ Clipboard & Gửi</button>
  <script>
    const openerOrigin="*";
    document.getElementById('pasteSendBtn').addEventListener('click',async()=>{
      try{
        const text=await navigator.clipboard.readText();
        if(!text.trim()){alert("Clipboard trống.");return;}
        window.opener.postMessage({type:'GT_TRANSCRIPT',payload:text.trim()},openerOrigin);
      }catch(e){alert("Lỗi clipboard: "+e.message);}
    });
  </scr`+`ipt></body></html>`;
  translatePopup.document.open(); translatePopup.document.write(popupHtml); translatePopup.document.close();
}
window.addEventListener('message',ev=>{
  const {type,payload}=ev.data||{};
  if(type==='GT_TRANSCRIPT'){ processSpokenText(String(payload||'')); }
});

// So sánh
function lcs(a,b){const m=a.length,n=b.length;const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);}}let i=m,j=n,res=[];while(i>0&&j>0){if(a[i-1]===b[j-1]){res.unshift(a[i-1]);i--;j--;}else if(dp[i-1][j]>dp[i][j-1])i--;else j--;}return res;}
function createDiffHtml(originalText,spokenText){const clean=t=>t.toLowerCase().replace(/[^\w\s'äöüß]/g,'').split(/\s+/).filter(Boolean);const original=clean(originalText),spoken=clean(spokenText);const common=new Set(lcs(original,spoken));let correct=0;const spokenHtml=spoken.map(w=>{if(common.has(w)){correct++;return '<b>'+w+'</b>';}return '<span style="color:red">'+w+'</span>';}).join(' ');const originalHtml=original.map(w=>common.has(w)?w:'<i>'+w+'</i>').join(' ');const accuracy=original.length?Math.round((correct/original.length)*100):0;return {html:`<div><b>Câu gốc:</b> ${originalHtml}</div><div><b>Bạn nói:</b> ${spokenHtml}</div>`,accuracy};}

// Luồng chính
function updateScore(){scoreArea.textContent='Điểm: '+score;}
function updateDialogueDisplay(){const computerRole=userIsB?'A':'B';const userRole=userIsB?'B':'A';const computerText=userIsB?linesA[currentLineIndex]:linesB[currentLineIndex];const userText=userIsB?linesB[currentLineIndex]:linesA[currentLineIndex];document.getElementById('computer-line').textContent=`${computerRole} (Máy): ${computerText||'...'}`;userLineEl.textContent=userText||'...';userLineTitle.textContent=`Câu của bạn (${userRole}):`;userLineEl.style.display=isUserLineVisible?'block':'none';toggleBtn.textContent=isUserLineVisible?'Ẩn':'Hiện';}
function startPractice(){currentLineIndex=0;score=100;updateScore();document.getElementById('initial-setup').style.display='none';document.getElementById('practice-area').style.display='block';ensurePopup();updateDialogueDisplay();statusArea.textContent='Máy đang nói...';const next=userIsB?linesA[0]:linesB[0];if(next){speak(next,()=>handleNextTurn());}else{handleNextTurn();}}
function handleNextTurn(){const userText=userIsB?linesB[currentLineIndex]:linesA[currentLineIndex];if(userText){statusArea.textContent='Đến lượt bạn. Hãy dùng popup Google Dịch.';openTranslatePopup();}else{currentLineIndex++;if(currentLineIndex>=Math.max(linesA.length,linesB.length)){showReview();return;}const next=userIsB?linesA[currentLineIndex]:linesB[currentLineIndex];if(next){speak(next,()=>handleNextTurn());}else{showReview();}}}
function processSpokenText(spokenText){const targetText=userIsB?(linesB[currentLineIndex]||''):(linesA[currentLineIndex]||'');const {html,accuracy}=createDiffHtml(targetText,spokenText);if(accuracy>=90){statusArea.className='status success';statusArea.innerHTML='Tốt lắm! '+accuracy+'%';currentLineIndex++;if(currentLineIndex>=Math.max(linesA.length,linesB.length)){showReview();return;}updateDialogueDisplay();const next=userIsB?linesA[currentLineIndex]:linesB[currentLineIndex];if(next){speak(next,()=>handleNextTurn());}else{handleNextTurn();}}else{statusArea.className='status error';score=Math.max(0,score-5);updateScore();statusArea.innerHTML='Chưa đạt ('+accuracy+'%). Thử lại.<br>'+html;openTranslatePopup();}}
function showReview(){document.getElementById('practice-area').style.display='none';document.getElementById('review-area').style.display='block';statusArea.textContent='Kết thúc. Điểm: '+score;}

// Nút điều khiển
document.getElementById('load-btn').addEventListener('click',()=>{const full=(document.getElementById('dialogue-input').value||'').trim();if(!full){alert('Nhập hội thoại!');return;}const lines=full.split('\n').filter(x=>x.trim()!=='');linesA=[];linesB=[];lines.forEach(l=>{if(/^a:/i.test(l))linesA.push(l.slice(2).trim());else if(/^b:/i.test(l))linesB.push(l.slice(2).trim());});startPractice();});
document.getElementById('swap-roles-btn').addEventListener('click',()=>{userIsB=!userIsB;});
document.getElementById('toggle-line-btn').addEventListener('click',()=>{isUserLineVisible=!isUserLineVisible;updateDialogueDisplay();});
</script>
</body>
</html>
