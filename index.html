<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luyện Nói Tiếng Đức Pro - Nâng Cấp</title>
  <style>
    /* giữ nguyên CSS cũ */
  </style>
</head>
<body>
  <div id="score-area">Điểm: 100</div>
  <div class="container">
    <h1>Luyện Giao Tiếp Chuyên Nghiệp 🚀</h1>
    <!-- giữ nguyên phần HTML cũ -->
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function() {
    // --- giữ nguyên các biến cũ, CHỈ BỎ recognition ---
    const loadBtn = document.getElementById('load-btn');
    const swapRolesBtn = document.getElementById('swap-roles-btn');
    const toggleBtn = document.getElementById('toggle-line-btn');
    const recordBtn = document.getElementById('record-btn');
    const practiceArea = document.getElementById('practice-area');
    const computerLine = document.getElementById('computer-line');
    const userLine = document.getElementById('user-line');
    const userLineTitle = document.getElementById('user-line-title');
    const statusArea = document.getElementById('status-area');
    const initialSetup = document.getElementById('initial-setup');
    const sessionControlsArea = document.getElementById('session-controls-area');
    const reviewArea = document.getElementById('review-area');
    const reviewContent = document.getElementById('review-content');
    const playAllBtn = document.getElementById('play-all-btn');
    const restartSessionBtn = document.getElementById('restart-session-btn');
    const chooseNewBtn = document.getElementById('choose-new-btn');
    const rewardsInput = document.getElementById('rewards-input');
    const penaltiesInput = document.getElementById('penalties-input');
    const scoreArea = document.getElementById('score-area');
    const autoRecordCheckbox = document.getElementById('auto-record');

    let linesA = [], linesB = [], userRecordings = [];
    let currentLineIndex = 0;
    let userIsB = true;
    let isUserLineVisible = false;
    let score = 100;

    // --- Giữ lại các hàm cũ: speak, playAudioPromise, lcs, createDiffHtml, updateDialogueDisplay, showReview, updateScoreDisplay, getRandomItem ---
    // (không dán lại toàn bộ cho gọn, nhưng bạn giữ nguyên)

    function openGoogleTranslatePopup() {
      window.open(
        "popup.html",
        "gtPopup",
        "width=600,height=600"
      );
    }

    function startRecording() {
      statusArea.textContent = 'Mở Google Translate để bạn nói...';
      recordBtn.disabled = true;
      recordBtn.textContent = '🔴 Đang mở popup...';
      openGoogleTranslatePopup();
    }

    // Nhận transcript từ popup
    window.addEventListener("message", (event) => {
      if (!event.data) return;
      if (event.data.type === "gt_transcript") {
        const transcript = event.data.text;
        processFinalResult(transcript);
      }
    });

    async function processFinalResult(spokenText) {
      const targetText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
      const difficultyThreshold = parseInt(document.querySelector('input[name="difficulty"]:checked').value);
      const { html: diffHtml, accuracy } = createDiffHtml(targetText, spokenText.trim());

      if (accuracy >= difficultyThreshold) {
        statusArea.className = 'status success';
        const rewardMsg = getRandomItem(rewardsInput.value);
        statusArea.innerHTML = `${rewardMsg} (Độ chính xác: ${accuracy}%)`;
        currentLineIndex++;
        const conversationLength = Math.max(linesA.length, linesB.length);
        if (currentLineIndex >= conversationLength) {
          setTimeout(showReview, 1000);
          return;
        }
        updateDialogueDisplay();
        const nextLineToSpeak = userIsB ? linesA[currentLineIndex] : (linesB[currentLineIndex] || null);
        if (nextLineToSpeak) {
          statusArea.textContent = 'Máy đang nói...';
          recordBtn.disabled = true;
          recordBtn.textContent = '...';
          const speakPromise = new Promise(resolve => speak(nextLineToSpeak, resolve));
          await speakPromise;
          handleNextTurn();
        } else {
          handleNextTurn();
        }
      } else {
        statusArea.className = 'status error';
        score -= 5;
        updateScoreDisplay();
        const penaltyMsg = getRandomItem(penaltiesInput.value);
        statusArea.innerHTML = `<div style="margin-bottom: 10px;">${penaltyMsg} (${accuracy}%). Thử lại nhé! (-5 điểm)</div><div class="feedback-box">${diffHtml}</div>`;
        recordBtn.disabled = false;
        recordBtn.textContent = '🎤 Thử Lại';
      }
    }

    function handleNextTurn() {
      const userText = userIsB ? linesB[currentLineIndex] : linesA[currentLineIndex];
      if (userText) {
        if (autoRecordCheckbox.checked) {
          statusArea.textContent = 'Đến lượt bạn. Chuẩn bị mở popup...';
          setTimeout(startRecording, 500);
        } else {
          statusArea.textContent = 'Đến lượt bạn. Hãy nhấn nút để mở popup.';
          recordBtn.disabled = false;
          recordBtn.textContent = '🎤 Mở Popup Ghi Âm';
        }
      } else {
        currentLineIndex++;
        const conversationLength = Math.max(linesA.length, linesB.length);
        if (currentLineIndex >= conversationLength) {
          setTimeout(showReview, 1000);
          return;
        }
        const nextLineToSpeak = userIsB ? linesA[currentLineIndex] : linesB[currentLineIndex];
        if (nextLineToSpeak) {
          speak(nextLineToSpeak, handleNextTurn);
        } else {
          setTimeout(showReview, 1000);
        }
      }
    }

    // Giữ nguyên loadBtn, swapRolesBtn, toggleBtn, playAllBtn, restartSessionBtn, chooseNewBtn... (không thay đổi nhiều)
  });
  </script>
</body>
</html>
